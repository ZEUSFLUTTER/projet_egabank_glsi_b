<div class="d-flex align-items-start align-items-md-center flex-column flex-md-row pt-2 pb-4">
  <div class="ms-md-auto py-2 py-md-0 d-flex gap-2 flex-wrap">
    <button
      type="button"
      class="btn btn-primary btn-round"
      data-bs-toggle="modal"
      data-bs-target="#modalTransaction"
    >
      <i class="fa fa-plus me-1"></i> Ajouter une transaction
    </button>

    <div class="input-group" style="max-width: 520px;">
      <input
        class="form-control"
        [(ngModel)]="ibanRecherche"
        placeholder="Numero de compte pour lister..."
        aria-label="IBAN pour lister"
      />

      <input
        class="form-control"
        type="date"
        [(ngModel)]="dateDebut"
        style="max-width: 170px;"
        aria-label="Date début"
      />

      <input
        class="form-control"
        type="date"
        [(ngModel)]="dateFin"
        style="max-width: 170px;"
        aria-label="Date fin"
      />

      <button
        type="button"
        class="btn btn-outline-primary"
        (click)="chercherTransactions()"
        [disabled]="chargementListe"
        aria-label="Rechercher"
      >
        <span *ngIf="chargementListe" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
        <i *ngIf="!chargementListe" class="fa fa-search"></i>
      </button>
    </div>
  </div>
</div>

<div class="alert alert-success py-2" *ngIf="messageSucces">{{ messageSucces }}</div>
<div class="alert alert-danger py-2" *ngIf="messageErreur">{{ messageErreur }}</div>

<div class="row">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h4 class="card-title mb-0">Liste des transactions</h4>
        <span class="text-muted" *ngIf="!chargementListe">{{ listeTransactions.length }} transaction(s)</span>
      </div>

      <div class="card-body">
        <div *ngIf="chargementListe" class="text-muted">Chargement...</div>

        <div class="table-responsive" *ngIf="!chargementListe">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Libellé</th>
                <th>Montant</th>
                <th>Destination</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let t of listeTransactions">
                <td>{{ t.dateOperation }}</td>
                <td>
                  <span class="badge bg-secondary">{{ t.typeTransaction }}</span>
                </td>
                <td>{{ t.libelle }}</td>
                <td>{{ t.montant | number:'1.0-0' }}</td>
                <td>
                  <ng-container *ngIf="t.compteDestination as dest; else videDest">
                    {{ dest.numeroCompte }}
                  </ng-container>
                  <ng-template #videDest><span class="text-muted">—</span></ng-template>
                </td>
              </tr>

              <tr *ngIf="listeTransactions.length === 0">
                <td colspan="5" class="text-center text-muted">Aucune transaction</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalTransaction" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fa fa-exchange-alt me-2"></i> Ajouter une transaction
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-danger py-2" *ngIf="erreurModal">
          {{ erreurModal }}
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label" for="client">Client</label>
            <select
              id="client"
              class="form-control"
              [(ngModel)]="idClientSelectionne"
              (ngModelChange)="chargerComptesClient()"
              name="client"
              (change)="chargerComptesClient()"
            >
              <option [ngValue]="null">-- Sélectionner --</option>
              <option *ngFor="let cl of listeClients" [ngValue]="cl.id">
                {{ cl.nom }} {{ cl.prenom }}
              </option>
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label class="form-label" for="filtreType">Filtre type compte</label>
            <select
              id="filtreType"
              class="form-control"
              [(ngModel)]="typeCompteFiltre"
              name="filtreType"
              (change)="appliquerFiltreTypeCompte()"
            >
              <option value="TOUS">Tous</option>
              <option value="COURANT">Courant</option>
              <option value="EPARGNE">Épargne</option>
            </select>
          </div>

          <div class="col-md-12 mb-3">
            <label class="form-label" for="compte">Compte (IBAN)</label>
            <select id="compte" class="form-control" [(ngModel)]="numeroCompteSelectionne" name="compte">
              <option value="">-- Sélectionner --</option>
              <option *ngFor="let cp of comptesFiltres" [value]="cp.numeroCompte">
                {{ cp.numeroCompte }} ({{ cp.typeCompte }}) - Solde: {{ cp.solde | number:'1.0-0' }}
              </option>
            </select>
            <small class="text-muted" *ngIf="comptesFiltres.length === 0">Aucun compte pour ce client/filtre.</small>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label" for="typeOperation">Type opération</label>
            <select id="typeOperation" class="form-control" [(ngModel)]="typeOperation" name="typeOperation">
              <option value="DEPOT">Dépôt</option>
              <option value="RETRAIT">Retrait</option>
              <option value="VIREMENT">Virement</option>
            </select>
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label" for="montant">Montant</label>
            <input id="montant" class="form-control" type="number" [(ngModel)]="montant" name="montant" min="0" />
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label" for="libelle">Libellé</label>
            <input id="libelle" class="form-control" [(ngModel)]="libelle" name="libelle" />
          </div>

          <div class="col-md-12 mb-3" *ngIf="typeOperation === 'VIREMENT'">
            <label class="form-label" for="destination">Compte destination (IBAN)</label>
            <input
              id="destination"
              class="form-control"
              [(ngModel)]="numeroCompteDestination"
              name="destination"
              placeholder="IBAN destination"
            />
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          (click)="reinitialiserFormulaireTransaction()"
          [disabled]="creationEnCours"
        >
          Fermer
        </button>

        <button
          type="button"
          class="btn btn-primary"
          (click)="creerTransaction()"
          [disabled]="creationEnCours"
        >
          <span *ngIf="creationEnCours" class="spinner-border spinner-border-sm me-2" aria-hidden="true"></span>
          <i *ngIf="!creationEnCours" class="fa fa-save me-1"></i> Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>
