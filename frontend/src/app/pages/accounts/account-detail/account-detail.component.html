<div class="account-detail-container">
  <!-- Header -->
  <div class="detail-header">
    <div class="header-content">
      <div class="header-left">
        <button nbButton ghost size="small" (click)="onBack()" class="back-btn">
          <nb-icon icon="arrow-back-outline"></nb-icon>
        </button>
        <div>
          <h1 class="detail-title">
            <nb-icon [icon]="account ?  getAccountTypeIcon(account.accountType) : 'credit-card-outline'"></nb-icon>
            Détails du Compte
          </h1>
          <p class="detail-subtitle" *ngIf="account">
            {{ formatAccountNumber(account.accountNumber) }}
          </p>
        </div>
      </div>
      <div class="header-actions" *ngIf="account">
        <button nbButton status="success" (click)="onGenerateStatement()">
          <nb-icon icon="file-text-outline"></nb-icon>
          Relevé
        </button>
        <button nbButton status="danger" ghost (click)="onDeleteAccount()">
          <nb-icon icon="trash-outline"></nb-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <nb-spinner size="giant" status="primary"></nb-spinner>
    <p class="loading-text">Chargement des détails... </p>
  </div>

  <!-- Contenu -->
  <div *ngIf="! isLoading && account" class="detail-content">
    <!-- Carte principale du compte -->
    <nb-card class="balance-card">
      <nb-card-body>
        <div class="balance-content">
          <div class="balance-left">
            <div class="account-info">
              <div class="account-type-badge" [ngClass]="'type-' + (account.accountType === 'SAVINGS' ? 'success' : 'primary')">
                <nb-icon [icon]="getAccountTypeIcon(account.accountType)"></nb-icon>
                <span>{{ getAccountTypeLabel(account.accountType) }}</span>
              </div>
              <nb-badge [text]="getStatusLabel(account.status)" [status]="getStatusColor(account.status)"></nb-badge>
            </div>
            <div class="account-number">
              <small>Numéro de compte</small>
              <div class="number-value">{{ formatAccountNumber(account.accountNumber) }}</div>
            </div>
          </div>
          <div class="balance-right">
            <div class="balance-display">
              <small>Solde disponible</small>
              <div
                class="balance-value"
                [ngClass]="{
                  positive: account.balance > 0,
                  zero: account.balance === 0,
                  negative: account.balance < 0
                }"
              >
                {{ formatCurrency(account.balance) }}
              </div>
              <small class="currency">{{ account.currency }}</small>
            </div>
          </div>
        </div>
      </nb-card-body>
    </nb-card>

    <!-- Actions rapides -->
    <div class="quick-actions">
      <button nbButton status="success" size="large" (click)="onDeposit()">
        <nb-icon icon="arrow-downward-outline"></nb-icon>
        <span>Dépôt</span>
      </button>
      <button nbButton status="danger" size="large" (click)="onWithdraw()">
        <nb-icon icon="arrow-upward-outline"></nb-icon>
        <span>Retrait</span>
      </button>
      <button nbButton status="primary" size="large" (click)="onTransfer()">
        <nb-icon icon="swap-outline"></nb-icon>
        <span>Virement</span>
      </button>
      <button nbButton status="info" size="large" (click)="onViewAllTransactions()">
        <nb-icon icon="list-outline"></nb-icon>
        <span>Historique</span>
      </button>
    </div>

    <!-- Grille de contenu -->
    <div class="detail-grid">
      <!-- Colonne principale -->
      <div class="detail-main">
        <!-- Statistiques du compte -->
        <nb-card class="stats-card">
          <nb-card-header>
            <h6>
              <nb-icon icon="bar-chart-outline"></nb-icon>
              Statistiques du Compte
            </h6>
          </nb-card-header>
          <nb-card-body>
            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-icon stat-success">
                  <nb-icon icon="arrow-downward-outline"></nb-icon>
                </div>
                <div class="stat-content">
                  <div class="stat-value">{{ formatCurrency(accountStats.depositAmount) }}</div>
                  <div class="stat-label">Total Dépôts</div>
                  <small>{{ accountStats.totalDeposits }} opération(s)</small>
                </div>
              </div>

              <div class="stat-item">
                <div class="stat-icon stat-danger">
                  <nb-icon icon="arrow-upward-outline"></nb-icon>
                </div>
                <div class="stat-content">
                  <div class="stat-value">{{ formatCurrency(accountStats.withdrawalAmount) }}</div>
                  <div class="stat-label">Total Retraits</div>
                  <small>{{ accountStats.totalWithdrawals }} opération(s)</small>
                </div>
              </div>

              <div class="stat-item">
                <div class="stat-icon stat-primary">
                  <nb-icon icon="swap-outline"></nb-icon>
                </div>
                <div class="stat-content">
                  <div class="stat-value">{{ formatCurrency(accountStats. transferAmount) }}</div>
                  <div class="stat-label">Total Virements</div>
                  <small>{{ accountStats.totalTransfers }} opération(s)</small>
                </div>
              </div>

              <div class="stat-item">
                <div class="stat-icon stat-info">
                  <nb-icon icon="activity-outline"></nb-icon>
                </div>
                <div class="stat-content">
                  <div class="stat-value">{{ formatNumber(accountStats.totalTransactions) }}</div>
                  <div class="stat-label">Total Transactions</div>
                  <small>Moyenne:  {{ formatCurrency(accountStats.averageTransaction) }}</small>
                </div>
              </div>
            </div>
          </nb-card-body>
        </nb-card>

        <!-- Dernières transactions -->
        <nb-card class="transactions-card">
          <nb-card-header>
            <div class="card-header-flex">
              <h6>
                <nb-icon icon="clock-outline"></nb-icon>
                Dernières Transactions
              </h6>
              <button nbButton ghost size="small" (click)="onViewAllTransactions()">
                Voir tout
                <nb-icon icon="arrow-forward-outline"></nb-icon>
              </button>
            </div>
          </nb-card-header>
          <nb-card-body>
            <div *ngIf="isLoadingTransactions" class="loading-transactions">
              <nb-spinner size="large" status="primary"></nb-spinner>
            </div>

            <div *ngIf="!isLoadingTransactions && recentTransactions.length > 0" class="transactions-list">
              <div *ngFor="let transaction of recentTransactions" class="transaction-item">
                <div class="transaction-icon" [ngClass]="'icon-' + getTransactionTypeColor(transaction.transactionType)">
                  <nb-icon [icon]="getTransactionTypeIcon(transaction.transactionType)"></nb-icon>
                </div>
                <div class="transaction-info">
                  <div class="transaction-type">{{ getTransactionTypeLabel(transaction.transactionType) }}</div>
                  <small class="transaction-date">{{ formatDateTime(transaction.transactionDate) }}</small>
                  <small class="transaction-ref" *ngIf="transaction.description">{{ transaction.description }}</small>
                </div>
                <div
                  class="transaction-amount"
                  [ngClass]="{
                    'amount-positive': transaction.transactionType === 'DEPOSIT',
                    'amount-negative': transaction.transactionType === 'WITHDRAWAL' || transaction.transactionType === 'TRANSFER'
                  }"
                >
                  <div class="amount-value">
                    {{ transaction.transactionType === "DEPOSIT" ? "+" : "-" }}{{ formatCurrency(Math.abs(transaction.amount)) }}
                  </div>
                  <small class="amount-balance">Solde: {{ formatCurrency(transaction.balanceAfter) }}</small>
                </div>
              </div>
            </div>

            <div *ngIf="!isLoadingTransactions && recentTransactions.length === 0" class="no-transactions">
              <nb-icon icon="inbox-outline"></nb-icon>
              <p>Aucune transaction enregistrée</p>
              <button nbButton status="primary" size="small" (click)="onDeposit()">Effectuer un dépôt</button>
            </div>
          </nb-card-body>
        </nb-card>
      </div>

      <!-- Sidebar -->
      <div class="detail-sidebar">
        <!-- Informations du compte -->
        <nb-card class="info-card">
          <nb-card-header>
            <h6>
              <nb-icon icon="info-outline"></nb-icon>
              Informations du Compte
            </h6>
          </nb-card-header>
          <nb-card-body>
            <div class="info-item">
              <div class="info-label">
                <nb-icon icon="calendar-outline"></nb-icon>
                Date d'ouverture
              </div>
              <div class="info-value">{{ formatDate(account.createdAt) }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">
                <nb-icon icon="clock-outline"></nb-icon>
                Ancienneté
              </div>
              <div class="info-value">{{ accountStats.accountAge }} jours</div>
            </div>
            <div class="info-item">
              <div class="info-label">
                <nb-icon icon="globe-outline"></nb-icon>
                Devise
              </div>
              <div class="info-value">{{ account.currency }}</div>
            </div>
            <div class="info-item">
              <div class="info-label">
                <nb-icon icon="activity-outline"></nb-icon>
                Activité mensuelle
              </div>
              <div class="info-value">{{ accountStats.monthlyAverage. toFixed(1) }} transactions/mois</div>
            </div>
            <div class="info-item" *ngIf="accountStats.lastTransactionDate">
              <div class="info-label">
                <nb-icon icon="flash-outline"></nb-icon>
                Dernière activité
              </div>
              <div class="info-value">{{ formatDateTime(accountStats.lastTransactionDate) }}</div>
            </div>
          </nb-card-body>
        </nb-card>

        <!-- Informations du client -->
        <nb-card class="customer-card" *ngIf="customer">
          <nb-card-header>
            <h6>
              <nb-icon icon="person-outline"></nb-icon>
              Titulaire du Compte
            </h6>
          </nb-card-header>
          <nb-card-body>
            <div class="customer-avatar">
              <nb-icon icon="person-outline"></nb-icon>
            </div>
            <div class="customer-name">{{ customer.lastName }} {{ customer.firstName }}</div>
            <div class="customer-details">
              <div class="detail-row">
                <nb-icon icon="email-outline"></nb-icon>
                <span>{{ customer.email }}</span>
              </div>
              <div class="detail-row">
                <nb-icon icon="phone-outline"></nb-icon>
                <span>{{ customer.phoneNumber }}</span>
              </div>
              <div class="detail-row">
                <nb-icon icon="calendar-outline"></nb-icon>
                <span>{{ customer.age }} ans</span>
              </div>
            </div>
            <button nbButton status="primary" fullWidth size="small" (click)="onViewCustomer()">
              <nb-icon icon="eye-outline"></nb-icon>
              Voir la fiche complète
            </button>
          </nb-card-body>
        </nb-card>

        <!-- Actions -->
        <nb-card class="actions-card">
          <nb-card-header>
            <h6>
              <nb-icon icon="options-outline"></nb-icon>
              Actions
            </h6>
          </nb-card-header>
          <nb-card-body>
            <div class="action-list">
              <button nbButton fullWidth ghost (click)="onGenerateStatement()">
                <nb-icon icon="file-text-outline"></nb-icon>
                Générer un relevé
              </button>
              <button nbButton fullWidth ghost status="danger" (click)="onDeleteAccount()">
                <nb-icon icon="trash-outline"></nb-icon>
                Supprimer le compte
              </button>
            </div>
          </nb-card-body>
        </nb-card>
      </div>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="! isLoading && !account" class="error-container">
    <nb-icon icon="alert-circle-outline"></nb-icon>
    <h4>Compte introuvable</h4>
    <p>Le compte demandé n'existe pas ou a été supprimé</p>
    <button nbButton status="primary" size="large" (click)="onBack()">
      <nb-icon icon="arrow-back-outline"></nb-icon>
      Retour à la liste
    </button>
  </div>
</div>