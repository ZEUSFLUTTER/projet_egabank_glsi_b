<div class="deposit-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <button nbButton ghost size="small" (click)="onCancel()" class="back-btn">
          <nb-icon icon="arrow-back-outline"></nb-icon>
        </button>
        <div>
          <h1 class="page-title">
            <nb-icon icon="arrow-downward-outline"></nb-icon>
            Dépôt Bancaire
          </h1>
          <p class="page-subtitle">Ajouter des fonds sur un compte</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Steps -->
  <div class="steps-progress">
    <div class="steps-container">
      <div class="step-item" [class.active]="currentStep >= 1" [class.completed]="currentStep > 1">
        <div class="step-circle">
          <nb-icon *ngIf="currentStep > 1" icon="checkmark-outline"></nb-icon>
          <span *ngIf="currentStep <= 1">1</span>
        </div>
        <div class="step-label">Compte</div>
      </div>

      <div class="step-line" [class.active]="currentStep >= 2"></div>

      <div class="step-item" [class.active]="currentStep >= 2" [class.completed]="currentStep > 2">
        <div class="step-circle">
          <nb-icon *ngIf="currentStep > 2" icon="checkmark-outline"></nb-icon>
          <span *ngIf="currentStep <= 2">2</span>
        </div>
        <div class="step-label">Montant</div>
      </div>

      <div class="step-line" [class.active]="currentStep >= 3"></div>

      <div class="step-item" [class.active]="currentStep >= 3">
        <div class="step-circle">
          <span>3</span>
        </div>
        <div class="step-label">Confirmation</div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <nb-spinner size="giant" status="primary"></nb-spinner>
    <p class="loading-text">Chargement des comptes...</p>
  </div>

  <!-- Formulaire -->
  <div *ngIf="!isLoading" class="form-content">
    <form [formGroup]="depositForm" (ngSubmit)="onSubmit()">
      <div class="form-grid">
        <!-- Colonne principale -->
        <div class="form-main">
          <!-- ÉTAPE 1: Sélection du compte -->
          <nb-card *ngIf="currentStep === 1" class="step-card">
            <nb-card-header>
              <div class="step-header">
                <div class="step-badge">Étape 1/3</div>
                <h3>Sélection du Compte</h3>
                <p>Choisissez le compte à créditer</p>
              </div>
            </nb-card-header>

            <nb-card-body>
              <div class="form-section">
                <label for="accountId" class="form-label required">Compte bénéficiaire</label>
                <nb-select
                  id="accountId"
                  fullWidth
                  size="large"
                  formControlName="accountId"
                  placeholder="Sélectionnez un compte..."
                  [status]="f.accountId.invalid && f.accountId.touched ?  'danger' : 'basic'"
                  (selectedChange)="onAccountSelect()"
                >
                  <nb-option *ngFor="let account of accounts" [value]="account.id">
                    <div class="account-option">
                      <div class="account-icon">
                        <nb-icon [icon]="account.accountType === 'SAVINGS' ? 'trending-up-outline' : 'credit-card-outline'"></nb-icon>
                      </div>
                      <div class="account-details">
                        <div class="account-number">{{ formatAccountNumber(account.accountNumber) }}</div>
                        <small>{{ account.customerFullName }}</small>
                      </div>
                      <div class="account-balance">{{ formatCurrency(account.balance) }}</div>
                    </div>
                  </nb-option>

                  <nb-option *ngIf="accounts.length === 0" disabled>Aucun compte actif disponible</nb-option>
                </nb-select>

                <div *ngIf="f.accountId.invalid && f.accountId. touched" class="field-error">
                  <nb-icon icon="alert-circle-outline"></nb-icon>
                  <span>La sélection d'un compte est obligatoire</span>
                </div>

                <!-- Carte du compte sélectionné -->
                <div *ngIf="selectedAccount" class="selected-account-card">
                  <div class="account-card-header">
                    <nb-icon [icon]="selectedAccount.accountType === 'SAVINGS' ? 'trending-up-outline' :  'credit-card-outline'"></nb-icon>
                    <nb-badge
                      [text]="selectedAccount.accountType === 'SAVINGS' ? 'Épargne' : 'Courant'"
                      [status]="selectedAccount.accountType === 'SAVINGS' ? 'success' : 'primary'"
                    ></nb-badge>
                  </div>

                  <div class="account-card-body">
                    <div class="account-info-item">
                      <small>Numéro de compte</small>
                      <strong>{{ formatAccountNumber(selectedAccount.accountNumber) }}</strong>
                    </div>
                    <div class="account-info-item">
                      <small>Titulaire</small>
                      <strong>{{ selectedAccount.customerFullName }}</strong>
                    </div>
                    <div class="account-info-item">
                      <small>Solde actuel</small>
                      <strong class="balance">{{ formatCurrency(selectedAccount.balance) }}</strong>
                    </div>
                    <div class="account-info-item">
                      <small>Devise</small>
                      <strong>{{ selectedAccount.currency }}</strong>
                    </div>
                  </div>
                </div>
              </div>
            </nb-card-body>

            <nb-card-footer>
              <div class="step-actions">
                <button nbButton status="basic" type="button" (click)="onCancel()">
                  <nb-icon icon="close-outline"></nb-icon>
                  Annuler
                </button>
                <button nbButton status="success" type="button" (click)="nextStep()" [disabled]="f.accountId.invalid">
                  Suivant
                  <nb-icon icon="arrow-forward-outline"></nb-icon>
                </button>
              </div>
            </nb-card-footer>
          </nb-card>

          <!-- ÉTAPE 2: Montant -->
          <nb-card *ngIf="currentStep === 2" class="step-card">
            <nb-card-header>
              <div class="step-header">
                <div class="step-badge">Étape 2/3</div>
                <h3>Montant du Dépôt</h3>
                <p>Indiquez le montant à déposer</p>
              </div>
            </nb-card-header>

            <nb-card-body>
              <!-- Montant -->
              <div class="form-section">
                <label for="amount" class="form-label required">Montant (F CFA)</label>
                <div class="amount-input-wrapper">
                  <nb-icon icon="cash-outline" class="input-icon"></nb-icon>
                  <input
                    type="number"
                    id="amount"
                    nbInput
                    fullWidth
                    size="giant"
                    formControlName="amount"
                    placeholder="0.00"
                    step="0.01"
                    min="0.01"
                    max="1000000"
                    [status]="f.amount.invalid && f.amount.touched ? 'danger' : 'basic'"
                  />
                </div>

                <div *ngIf="f.amount.invalid && f.amount.touched" class="field-error">
                  <nb-icon icon="alert-circle-outline"></nb-icon>
                  <span *ngIf="f.amount. errors?.['required']">Le montant est obligatoire</span>
                </div>

                <!-- Montants rapides -->
                <div class="quick-amounts">
                  <label class="quick-label">Montants suggérés</label>
                  <div class="quick-buttons">
                    <button *ngFor="let quickAmount of quickAmounts" nbButton ghost size="small" type="button" (click)="applyQuickAmount(quickAmount)">
                      {{ formatCurrency(quickAmount) }}
                    </button>
                  </div>
                </div>
              </div>

              <!-- Description optionnelle -->
              <div class="form-section">
                <label for="description" class="form-label">Description (optionnel)</label>
                <textarea
                  id="description"
                  nbInput
                  fullWidth
                  rows="3"
                  formControlName="description"
                  placeholder="Motif du dépôt..."
                  maxlength="200"
                ></textarea>
                <small class="field-hint">Maximum 200 caractères</small>
              </div>
            </nb-card-body>

            <nb-card-footer>
              <div class="step-actions">
                <button nbButton status="basic" type="button" (click)="previousStep()">
                  <nb-icon icon="arrow-back-outline"></nb-icon>
                  Retour
                </button>
                <button nbButton status="success" type="button" (click)="nextStep()" [disabled]="f.amount.invalid">
                  Suivant
                  <nb-icon icon="arrow-forward-outline"></nb-icon>
                </button>
              </div>
            </nb-card-footer>
          </nb-card>

          <!-- ÉTAPE 3: Confirmation -->
          <nb-card *ngIf="currentStep === 3" class="step-card">
            <nb-card-header>
              <div class="step-header">
                <div class="step-badge">Étape 3/3</div>
                <h3>Confirmation du Dépôt</h3>
                <p>Vérifiez les informations avant de confirmer</p>
              </div>
            </nb-card-header>

            <nb-card-body>
              <div class="confirmation-summary">
                <!-- Montant principal -->
                <div class="summary-amount">
                  <div class="amount-icon">
                    <nb-icon icon="arrow-downward-outline"></nb-icon>
                  </div>
                  <div class="amount-value">{{ formatCurrency(f.amount.value) }}</div>
                  <div class="amount-label">Montant du dépôt</div>
                </div>

                <!-- Détails -->
                <div class="summary-details">
                  <div class="detail-row">
                    <span class="detail-label">
                      <nb-icon icon="credit-card-outline"></nb-icon>
                      Compte
                    </span>
                    <span class="detail-value">{{ formatAccountNumber(selectedAccount! .accountNumber) }}</span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">
                      <nb-icon icon="person-outline"></nb-icon>
                      Bénéficiaire
                    </span>
                    <span class="detail-value">{{ selectedAccount!.customerFullName }}</span>
                  </div>

                  <div class="detail-row" *ngIf="f.description.value">
                    <span class="detail-label">
                      <nb-icon icon="file-text-outline"></nb-icon>
                      Description
                    </span>
                    <span class="detail-value">{{ f.description.value }}</span>
                  </div>

                  <div class="detail-row divider">
                    <span class="detail-label">
                      <nb-icon icon="wallet-outline"></nb-icon>
                      Solde actuel
                    </span>
                    <span class="detail-value">{{ formatCurrency(selectedAccount! .balance) }}</span>
                  </div>

                  <div class="detail-row highlight">
                    <span class="detail-label">
                      <nb-icon icon="trending-up-outline"></nb-icon>
                      Nouveau solde
                    </span>
                    <span class="detail-value success">{{ formatCurrency(selectedAccount!.balance + f.amount.value) }}</span>
                  </div>
                </div>

                <!-- Informations importantes -->
                <nb-alert status="info" size="small" class="mt-3">
                  <div style="display: flex; align-items: center; gap: 0.5rem">
                    <nb-icon icon="info-outline"></nb-icon>
                    <div>
                      <strong>Le dépôt sera traité immédiatement</strong>
                    </div>
                  </div>
                </nb-alert>
              </div>
            </nb-card-body>

            <nb-card-footer>
              <div class="step-actions">
                <button nbButton status="basic" type="button" (click)="previousStep()" [disabled]="isSubmitting">
                  <nb-icon icon="arrow-back-outline"></nb-icon>
                  Retour
                </button>
                <button nbButton status="success" size="large" type="submit" [disabled]="depositForm.invalid || isSubmitting">
                  <nb-icon [icon]="isSubmitting ? 'loader-outline' : 'checkmark-circle-outline'" [class.spin]="isSubmitting"></nb-icon>
                  {{ isSubmitting ? 'Traitement.. .' : 'Confirmer le dépôt' }}
                </button>
              </div>
            </nb-card-footer>
          </nb-card>
        </div>

        <!-- Sidebar -->
        <div class="form-sidebar">
          <nb-card class="summary-card sticky">
            <nb-card-header>
              <h6>
                <nb-icon icon="clipboard-outline"></nb-icon>
                Récapitulatif
              </h6>
            </nb-card-header>
            <nb-card-body>
              <div class="summary-item" *ngIf="selectedAccount">
                <small>Compte</small>
                <strong>{{ formatAccountNumber(selectedAccount.accountNumber) }}</strong>
              </div>

              <div class="summary-item" *ngIf="f.amount.value">
                <small>Montant</small>
                <strong class="text-success">{{ formatCurrency(f.amount.value) }}</strong>
              </div>

              <div class="summary-divider"></div>

              <div class="summary-item total">
                <small>Total</small>
                <strong>{{ formatCurrency(calculateTotal()) }}</strong>
              </div>

              <div class="summary-progress">
                <small>Progression</small>
                <nb-progress-bar [value]="(currentStep / totalSteps) * 100" status="success"></nb-progress-bar>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
      </div>
    </form>
  </div>
</div>