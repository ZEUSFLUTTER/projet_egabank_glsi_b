<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Op√©rations Bancaires - API Backend</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        input, select { padding: 8px; margin: 5px; width: 200px; }
        .form-group { margin: 10px 0; }
        .form-row { display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ Test Op√©rations Bancaires - Syst√®me EGA</h1>
        
        <div class="test-section">
            <h2>1. Pr√©paration - Cr√©er un Client et un Compte</h2>
            <button onclick="creerClientEtCompte()">Cr√©er Client + Compte de Test</button>
            <div id="preparationResult"></div>
        </div>

        <div class="test-section">
            <h2>2. Lister les Comptes Disponibles</h2>
            <button onclick="listerComptes()">Lister tous les comptes</button>
            <div id="comptesResult"></div>
        </div>

        <div class="test-section">
            <h2>3. Effectuer un D√©p√¥t</h2>
            <div class="form-group">
                <div class="form-row">
                    <label>Compte:</label>
                    <select id="compteDepot">
                        <option value="">S√©lectionner un compte</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Montant:</label>
                    <input type="number" id="montantDepot" value="50000" min="1">
                    <label>Description:</label>
                    <input type="text" id="descriptionDepot" value="D√©p√¥t de test">
                </div>
                <button onclick="effectuerDepot()">Effectuer le d√©p√¥t</button>
            </div>
            <div id="depotResult"></div>
        </div>

        <div class="test-section">
            <h2>4. Effectuer un Retrait</h2>
            <div class="form-group">
                <div class="form-row">
                    <label>Compte:</label>
                    <select id="compteRetrait">
                        <option value="">S√©lectionner un compte</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Montant:</label>
                    <input type="number" id="montantRetrait" value="10000" min="1">
                    <label>Description:</label>
                    <input type="text" id="descriptionRetrait" value="Retrait de test">
                </div>
                <button onclick="effectuerRetrait()">Effectuer le retrait</button>
            </div>
            <div id="retraitResult"></div>
        </div>

        <div class="test-section">
            <h2>5. Effectuer un Virement</h2>
            <div class="form-group">
                <div class="form-row">
                    <label>Compte Source:</label>
                    <select id="compteSource">
                        <option value="">S√©lectionner un compte</option>
                    </select>
                </div>
                <div class="form-row">
                    <label>Compte Destinataire:</label>
                    <input type="text" id="compteDestinataire" placeholder="Num√©ro de compte destinataire">
                </div>
                <div class="form-row">
                    <label>Montant:</label>
                    <input type="number" id="montantVirement" value="5000" min="1">
                    <label>Description:</label>
                    <input type="text" id="descriptionVirement" value="Virement de test">
                </div>
                <button onclick="effectuerVirement()">Effectuer le virement</button>
            </div>
            <div id="virementResult"></div>
        </div>

        <div class="test-section">
            <h2>6. Historique des Transactions</h2>
            <button onclick="listerTransactions()">Lister toutes les transactions</button>
            <div id="transactionsResult"></div>
        </div>

        <div class="test-section">
            <h2>7. Logs de Debug</h2>
            <div id="debugLogs"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let comptesDisponibles = [];
        
        function log(message, type = 'info') {
            const debugLogs = document.getElementById('debugLogs');
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.innerHTML += `<div style="color: ${type === 'error' ? 'red' : 'blue'};">[${timestamp}] ${message}</div>`;
        }

        async function creerClientEtCompte() {
            const resultDiv = document.getElementById('preparationResult');
            resultDiv.innerHTML = '<p>‚è≥ Cr√©ation du client et du compte...</p>';
            
            try {
                // 1. Cr√©er un client
                const clientData = {
                    nom: "TestOp",
                    prenom: "Bancaire",
                    dateNaissance: "1985-03-20",
                    sexe: "M",
                    adresse: "456 Avenue des Tests, Dakar",
                    numeroTelephone: "+221779876543",
                    courriel: "test.operations@bank.com",
                    nationalite: "S√©n√©galaise"
                };
                
                log('Cr√©ation du client de test...');
                const clientResponse = await fetch(`${API_BASE}/clients`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clientData)
                });
                
                if (!clientResponse.ok) {
                    throw new Error(`Erreur cr√©ation client: ${clientResponse.status}`);
                }
                
                const client = await clientResponse.json();
                log(`Client cr√©√©: ID ${client.id}`);
                
                // 2. Cr√©er un compte pour ce client
                const compteData = {
                    proprietaireId: client.id,
                    typeCompte: "COURANT",
                    solde: 100000 // Solde initial de 100,000 XOF
                };
                
                log('Cr√©ation du compte de test...');
                const compteResponse = await fetch(`${API_BASE}/comptes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(compteData)
                });
                
                if (!compteResponse.ok) {
                    throw new Error(`Erreur cr√©ation compte: ${compteResponse.status}`);
                }
                
                const compte = await compteResponse.json();
                log(`Compte cr√©√©: ${compte.numeroCompte}`);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Client et compte cr√©√©s avec succ√®s !<br>
                        Client: ${client.nom} ${client.prenom} (ID: ${client.id})<br>
                        Compte: ${compte.numeroCompte} - Solde: ${compte.solde.toLocaleString()} XOF
                    </div>
                `;
                
                // Actualiser la liste des comptes
                setTimeout(listerComptes, 1000);
                
            } catch (error) {
                log(`Erreur: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function listerComptes() {
            const resultDiv = document.getElementById('comptesResult');
            resultDiv.innerHTML = '<p>‚è≥ Chargement des comptes...</p>';
            
            try {
                log('R√©cup√©ration des comptes...');
                const response = await fetch(`${API_BASE}/comptes`);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                
                const comptes = await response.json();
                comptesDisponibles = comptes;
                log(`${comptes.length} comptes trouv√©s`);
                
                // Mettre √† jour les s√©lecteurs
                updateCompteSelectors(comptes);
                
                if (comptes.length === 0) {
                    resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Aucun compte trouv√©. Cr√©ez d\'abord un client et un compte.</div>';
                } else {
                    let html = '<div class="success">‚úÖ Comptes disponibles:<br>';
                    comptes.forEach(compte => {
                        html += `‚Ä¢ ${compte.numeroCompte} - ${compte.typeCompte} - ${compte.solde.toLocaleString()} XOF (${compte.proprietaireNom} ${compte.proprietairePrenom})<br>`;
                    });
                    html += '</div>';
                    resultDiv.innerHTML = html;
                }
                
            } catch (error) {
                log(`Erreur: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        function updateCompteSelectors(comptes) {
            const selectors = ['compteDepot', 'compteRetrait', 'compteSource'];
            
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                selector.innerHTML = '<option value="">S√©lectionner un compte</option>';
                
                comptes.forEach(compte => {
                    const option = document.createElement('option');
                    option.value = compte.numeroCompte;
                    option.textContent = `${compte.numeroCompte} - ${compte.solde.toLocaleString()} XOF`;
                    selector.appendChild(option);
                });
            });
            
            // Pour le virement, remplir aussi le destinataire avec un autre compte
            if (comptes.length > 1) {
                document.getElementById('compteDestinataire').value = comptes[1].numeroCompte;
            }
        }

        async function effectuerDepot() {
            const resultDiv = document.getElementById('depotResult');
            const numeroCompte = document.getElementById('compteDepot').value;
            const montant = parseFloat(document.getElementById('montantDepot').value);
            const description = document.getElementById('descriptionDepot').value;
            
            if (!numeroCompte || !montant) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez remplir tous les champs</div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>‚è≥ Effectuer le d√©p√¥t...</p>';
            
            try {
                const operationData = {
                    numeroCompte: numeroCompte,
                    montant: montant,
                    description: description
                };
                
                log(`D√©p√¥t: ${montant} XOF sur ${numeroCompte}`);
                const response = await fetch(`${API_BASE}/transactions/depot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(operationData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erreur HTTP ${response.status}`);
                }
                
                const transaction = await response.json();
                log(`D√©p√¥t r√©ussi: Transaction ID ${transaction.id}`);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ D√©p√¥t effectu√© avec succ√®s !<br>
                        Montant: ${transaction.montant.toLocaleString()} XOF<br>
                        Nouveau solde: ${transaction.soldeApres.toLocaleString()} XOF<br>
                        Transaction ID: ${transaction.id}
                    </div>
                `;
                
                // Actualiser la liste des comptes
                setTimeout(listerComptes, 1000);
                
            } catch (error) {
                log(`Erreur d√©p√¥t: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function effectuerRetrait() {
            const resultDiv = document.getElementById('retraitResult');
            const numeroCompte = document.getElementById('compteRetrait').value;
            const montant = parseFloat(document.getElementById('montantRetrait').value);
            const description = document.getElementById('descriptionRetrait').value;
            
            if (!numeroCompte || !montant) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez remplir tous les champs</div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>‚è≥ Effectuer le retrait...</p>';
            
            try {
                const operationData = {
                    numeroCompte: numeroCompte,
                    montant: montant,
                    description: description
                };
                
                log(`Retrait: ${montant} XOF sur ${numeroCompte}`);
                const response = await fetch(`${API_BASE}/transactions/retrait`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(operationData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erreur HTTP ${response.status}`);
                }
                
                const transaction = await response.json();
                log(`Retrait r√©ussi: Transaction ID ${transaction.id}`);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Retrait effectu√© avec succ√®s !<br>
                        Montant: ${transaction.montant.toLocaleString()} XOF<br>
                        Nouveau solde: ${transaction.soldeApres.toLocaleString()} XOF<br>
                        Transaction ID: ${transaction.id}
                    </div>
                `;
                
                // Actualiser la liste des comptes
                setTimeout(listerComptes, 1000);
                
            } catch (error) {
                log(`Erreur retrait: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function effectuerVirement() {
            const resultDiv = document.getElementById('virementResult');
            const compteSource = document.getElementById('compteSource').value;
            const compteDestinataire = document.getElementById('compteDestinataire').value;
            const montant = parseFloat(document.getElementById('montantVirement').value);
            const description = document.getElementById('descriptionVirement').value;
            
            if (!compteSource || !compteDestinataire || !montant) {
                resultDiv.innerHTML = '<div class="error">‚ùå Veuillez remplir tous les champs</div>';
                return;
            }
            
            if (compteSource === compteDestinataire) {
                resultDiv.innerHTML = '<div class="error">‚ùå Le compte source et destinataire doivent √™tre diff√©rents</div>';
                return;
            }
            
            resultDiv.innerHTML = '<p>‚è≥ Effectuer le virement...</p>';
            
            try {
                const virementData = {
                    compteSource: compteSource,
                    compteDestinataire: compteDestinataire,
                    montant: montant,
                    description: description
                };
                
                log(`Virement: ${montant} XOF de ${compteSource} vers ${compteDestinataire}`);
                const response = await fetch(`${API_BASE}/transactions/virement`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(virementData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Erreur HTTP ${response.status}`);
                }
                
                const transactions = await response.json();
                log(`Virement r√©ussi: ${transactions.length} transactions cr√©√©es`);
                
                resultDiv.innerHTML = `
                    <div class="success">
                        ‚úÖ Virement effectu√© avec succ√®s !<br>
                        Montant: ${montant.toLocaleString()} XOF<br>
                        De: ${compteSource}<br>
                        Vers: ${compteDestinataire}<br>
                        ${transactions.length} transactions cr√©√©es
                    </div>
                `;
                
                // Actualiser la liste des comptes
                setTimeout(listerComptes, 1000);
                
            } catch (error) {
                log(`Erreur virement: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        async function listerTransactions() {
            const resultDiv = document.getElementById('transactionsResult');
            resultDiv.innerHTML = '<p>‚è≥ Chargement des transactions...</p>';
            
            try {
                log('R√©cup√©ration des transactions...');
                const response = await fetch(`${API_BASE}/transactions`);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                
                const transactions = await response.json();
                log(`${transactions.length} transactions trouv√©es`);
                
                if (transactions.length === 0) {
                    resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Aucune transaction trouv√©e</div>';
                } else {
                    let html = '<div class="success">‚úÖ Derni√®res transactions:<br><pre>';
                    transactions.slice(-10).reverse().forEach(t => {
                        const date = new Date(t.dateTransaction).toLocaleString('fr-FR');
                        html += `${date} | ${t.typeTransaction} | ${t.montant.toLocaleString()} XOF | ${t.numeroCompte} | ${t.description || ''}\n`;
                    });
                    html += '</pre></div>';
                    resultDiv.innerHTML = html;
                }
                
            } catch (error) {
                log(`Erreur: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
            }
        }

        // Initialisation
        window.onload = function() {
            log('Page de test des op√©rations bancaires charg√©e');
            listerComptes();
        };
    </script>
</body>
</html>